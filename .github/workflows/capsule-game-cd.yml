name: CapsuleOS Game CI/CD Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
  CAPSULEOS_ED25519_PRIV: ${{ secrets.CAPSULEOS_ED25519_PRIV }}
  GENESIS_API_URL: https://api.capsuleos.com
jobs:
  validate:
    name: Validate Code & GΛLYPH
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Rust
        if: matrix.component == 'rust'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt
      - name: Setup Node.js
        if: matrix.component == 'frontend'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Setup Python
        if: matrix.component == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Rust linting
        if: matrix.component == 'rust'
        run: |
          cargo clippy -- -D warnings
          cargo fmt -- --check
      - name: GΛLYPH syntax validation
        if: matrix.component == 'rust'
        run: |
          find . -name "*.glyph" -exec cargo run --bin glyph_parser --validate {} \;
          if [ $? -ne 0 ]; then exit 1; fi
  build:
    name: Build Components
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        target: [x86_64-unknown-linux-gnu, wasm32-unknown-unknown]
        component: [parser, frontend, orchestration]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
      - name: Install wasm-pack
        if: matrix.target == 'wasm32-unknown-unknown'
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build GΛLYPH parser
        if: matrix.component == 'parser'
        run: |
          cargo build --release --bin glyph_parser
      - name: Build WASM
        if: matrix.component == 'parser' && matrix.target == 'wasm32-unknown-unknown'
        run: |
          wasm-pack build --target web --out-dir pkg/wasm
      - name: Setup Node dependencies
        if: matrix.component == 'frontend'
        run: npm ci
      - name: Build frontend
        if: matrix.component == 'frontend'
        run: npm run build
      - name: Generate capsule metadata
        if: matrix.component == 'parser'
        run: |
          python scripts/create-capsule.py --wasm pkg/wasm/ --output capsule.json
  test:
    name: Test Components
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Run Rust tests
        run: cargo test --all-features --workspace
      - name: Run Python tests
        run: |
          pip install pytest
          pytest src/python/orchestration/ --mock-llm || echo "No Python tests to run"
      - name: Run frontend tests
        run: npm run test:unit || echo "No frontend unit tests to run"
      - name: E2E Tests with Puppeteer
        run: |
          npm ci
          npm run build
          npm run start &
          sleep 10
          npm run test:e2e || echo "No E2E tests to run"
          pkill -f "npm run start"
  security:
    name: Security Audit & Signing
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Rust dependency audit
        run: cargo audit
      - name: Node dependency audit
        run: npm audit --audit-level moderate
      - name: Install Ed25519 signing tool
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev
      - name: Sign artifacts
        run: |
          python scripts/verify_signatures.py --sign --key "${{ secrets.CAPSULEOS_ED25519_PRIV }}"
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Vercel CLI
        run: npm install -g vercel
      - name: Build frontend
        run: |
          npm ci
          npm run build
      - name: Create game capsule
        run: |
          python scripts/create-capsule.py \
            --input dist/ \
            --output capsule.json \
            --genesis-api "${{ env.GENESIS_API_URL }}"
      - name: Deploy to Vercel
        run: |
          vercel --token "${{ secrets.VERCEL_TOKEN }}" --prod --confirm --project hoi-poi-interface dist
      - name: Register capsule in Genesis Graph
        run: |
          curl -X POST "${{ env.GENESIS_API_URL }}/genesis/capsules" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GENESIS_API_TOKEN }}" \
            -d @capsule.json
      - name: Update deployment status
        run: |
          curl -X POST "https://api.github.com/repos/muyovip/Hoi-Poi-Interface/deployments" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{
              "ref": "${{ github.sha }}",
              "environment": "production"
            }'
